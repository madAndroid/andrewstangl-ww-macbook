apiVersion: templates.weave.works/v1alpha2
kind: GitOpsTemplate
metadata:
  name: aws-eks-dev
  namespace: default
  annotations:
    templates.weave.works/inject-prune-annotation: "true"
    templates.weave.works/add-common-bases: "false"
    templates.weave.works/credentials-enabled: "true"
  labels:
    weave.works/template-type: cluster
spec:
  description: AWS EKS Development Cluster
  params:
    - name: CLUSTER_NAME
      description: The name for this cluster.
    - name: AWS_REGION
      description: AWS Region to create cluster
      options: ["eu-west-1", "eu-central-1", "eu-west-2", "us-west-2"]
      default: "eu-west-1"
    - name: KUBERNETES_VERSION
      description: EKS Kubernetes version to use
      options: ["v1.23", "v1.24", "v1.25", "v1.26", "v1.27"]
      default: "v1.27"
    - name: WORKER_MACHINE_COUNT
      description: Number of worker nodes to create.
      default: "3"
  resourcetemplates:
    - content:
        - apiVersion: gitops.weave.works/v1alpha1
          kind: GitopsCluster
          metadata:
            name: "${CLUSTER_NAME}"
            namespace: default
            labels:
              weave.works/capi: bootstrap
          spec:
            capiClusterRef:
              name: "${CLUSTER_NAME}"

        - apiVersion: cluster.x-k8s.io/v1beta1
          kind: Cluster
          metadata:
            name: ${CLUSTER_NAME}
            namespace: default
            labels:
              weave.works/capi: bootstrap
          spec:
            clusterNetwork:
              pods:
                cidrBlocks:
                  - 192.168.0.0/16
            controlPlaneRef:
              apiVersion: controlplane.cluster.x-k8s.io/v1beta1
              kind: AWSManagedControlPlane
              name: ${CLUSTER_NAME}-control-plane
            infrastructureRef:
              apiVersion: controlplane.cluster.x-k8s.io/v1beta1
              kind: AWSManagedControlPlane
              name: ${CLUSTER_NAME}-control-plane

        - apiVersion: controlplane.cluster.x-k8s.io/v1beta1
          kind: AWSManagedControlPlane
          metadata:
            name: ${CLUSTER_NAME}-control-plane
            namespace: default
          spec:
            region: ${AWS_REGION}
            sshKeyName: default
            version: ${KUBERNETES_VERSION}
            eksClusterName: ${CLUSTER_NAME}
            identityRef:
              kind: AWSClusterStaticIdentity
              name: capi-aws-creds

        - apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
          kind: AWSClusterStaticIdentity
          metadata:
            name: capi-aws-creds
          spec:
            secretRef: capi-aws-creds
            allowedNamespaces:
              list: ["default"]

        - apiVersion: cluster.x-k8s.io/v1beta1
          kind: MachinePool
          metadata:
            name: ${CLUSTER_NAME}-pool-0
            namespace: default
          spec:
            clusterName: ${CLUSTER_NAME}
            replicas: ${WORKER_MACHINE_COUNT}
            template:
              spec:
                bootstrap:
                  dataSecretName: ""
                clusterName: ${CLUSTER_NAME}
                infrastructureRef:
                  apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
                  kind: AWSManagedMachinePool
                  name: ${CLUSTER_NAME}-pool-0

        - apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
          kind: AWSManagedMachinePool
          metadata:
            name: ${CLUSTER_NAME}-pool-0
            namespace: default
          spec: {}

    # - path: clusters/(( .template.meta.namespace ))/(( .params.CLUSTER_NAME ))/bases.yaml
    #   content:
    #     apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
    #     kind: Kustomization
    #     metadata:
    #       name: wge-rbac
    #       namespace: flux-system
    #     spec:
    #       interval: 1m0s
    #       dependsOn:
    #         - name: config
    #       path: ./cluster/bases/rbac
    #       prune: true
    #       wait: true
    #       sourceRef:
    #         kind: GitRepository
    #         name: flux-system

    # - path: clusters/(( .template.meta.namespace ))/(( .params.CLUSTER_NAME ))/bases.yaml
    #   content:
    #     apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
    #     kind: Kustomization
    #     metadata:
    #       name: wge-rbac
    #       namespace: flux-system
    #     spec:
    #       interval: 1m0s
    #       dependsOn:
    #         - name: config
    #       path: ./cluster/bases/rbac
    #       prune: true
    #       wait: true
    #       sourceRef:
    #         kind: GitRepository
    #         name: flux-system
    #       postBuild:
    #         substituteFrom:
    #           - kind: ConfigMap
    #             name: cluster-config
